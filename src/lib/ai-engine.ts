interface Message {
  role: 'user' | 'assistant';
  content: string;
}

const responses: Record<string, string[]> = {
  greeting: [
    '–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ –æ–±—â–µ–Ω–∏—é —Å —Ç–æ–±–æ–π. –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?',
    '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ. –û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º?',
    '–ü—Ä–∏–≤–µ—Ç! –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞!',
  ],
  help: [
    '–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Å—É–¥–∏—Ç—å –∏–¥–µ–∏, –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å. –°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —É–≥–æ–¥–Ω–æ!',
    '–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å! –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –¥–µ–ª–∏—Å—å –º—ã—Å–ª—è–º–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π.',
  ],
  thanks: [
    '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –†–∞–¥ –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º üòä',
    '–í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å! –û–±—Ä–∞—â–∞–π—Å—è –µ—â—ë.',
    '–ù–µ –∑–∞ —á—Ç–æ! –ï—Å–ª–∏ –±—É–¥—É—Ç –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –∑–¥–µ—Å—å.',
  ],
  time: [
    `–°–µ–π—á–∞—Å ${new Date().toLocaleTimeString('ru-RU')}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`,
    `–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${new Date().toLocaleTimeString('ru-RU')}.`,
  ],
  date: [
    `–°–µ–≥–æ–¥–Ω—è ${new Date().toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`,
  ],
  weather: [
    '–Ø –Ω–µ –∏–º–µ—é –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –æ –ø–æ–≥–æ–¥–µ, –Ω–æ –º–æ–≥—É –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ü–æ–≥–æ–¥–µ –∏–ª–∏ Gismeteo!',
  ],
  joke: [
    '–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ª—é–±—è—Ç –ø—Ä–∏—Ä–æ–¥—É? –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–º –º–Ω–æ–≥–æ –≤–µ—Ç–æ–∫! üòÑ',
    '–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∫–æ–º–ø—å—é—Ç–µ—Ä –¥—Ä—É–≥–æ–º—É? "–¢—ã –º–µ–Ω—è –Ω–µ –±–∞–π—Ç–∏—à—å!" üíæ',
    '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∏–¥—ë—Ç –≤ –º–∞–≥–∞–∑–∏–Ω. –ñ–µ–Ω–∞ –≥–æ–≤–æ—Ä–∏—Ç: "–ö—É–ø–∏ –±–∞—Ç–æ–Ω —Ö–ª–µ–±–∞, –µ—Å–ª–∏ –±—É–¥—É—Ç —è–π—Ü–∞ ‚Äî –≤–æ–∑—å–º–∏ –¥–µ—Å—è—Ç–æ–∫". –û–Ω –≤–µ—Ä–Ω—É–ª—Å—è —Å 10 –±–∞—Ç–æ–Ω–∞–º–∏. "–ü–æ—á–µ–º—É?!" ‚Äî "–Ø–π—Ü–∞ –±—ã–ª–∏!" ü•ö',
  ],
  programming: [
    '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –∏–∑ –Ω–∏—á–µ–≥–æ! –ö–∞–∫–æ–π —è–∑—ã–∫ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?',
    '–ö–æ–¥ ‚Äî —ç—Ç–æ –ø–æ—ç–∑–∏—è –ª–æ–≥–∏–∫–∏. –û –∫–∞–∫–æ–º –∞—Å–ø–µ–∫—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?',
  ],
  ai: [
    '–ò–ò ‚Äî —ç—Ç–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∞—è –æ–±–ª–∞—Å—Ç—å! –Ø —Å–∞–º —Ä–∞–±–æ—Ç–∞—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.',
    '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –º–µ–Ω—è–µ—Ç –º–∏—Ä. –û—Ç —á–∞—Ç-–±–æ—Ç–æ–≤ –¥–æ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π ‚Äî —ç—Ç–æ –±—É–¥—É—â–µ–µ —É–∂–µ –∑–¥–µ—Å—å!',
  ],
  motivation: [
    '–í–µ—Ä—å –≤ —Å–µ–±—è! –ö–∞–∂–¥—ã–π –≤–µ–ª–∏–∫–∏–π –ø—Ä–æ–µ–∫—Ç –Ω–∞—á–∏–Ω–∞–ª—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞. üí™',
    '–¢—ã —Å–ø–æ—Å–æ–±–µ–Ω –Ω–∞ –±–æ–ª—å—à–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å! –ü—Ä–æ–¥–æ–ª–∂–∞–π –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥! üöÄ',
    '–ù–µ —Å–¥–∞–≤–∞–π—Å—è! –£—Å–ø–µ—Ö –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫ —Ç–µ–º, –∫—Ç–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤ –∏ –≤–µ—Ä–∏—Ç –≤ —Å–≤–æ—é —Ü–µ–ª—å.',
  ],
};

const keywords: Record<string, RegExp[]> = {
  greeting: [/–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Ö–∞–π|hi|hello/i],
  help: [/–ø–æ–º–æ—â—å|–ø–æ–º–æ–≥–∏|—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å|—á—Ç–æ –º–æ–∂–µ—à—å/i],
  thanks: [/—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é|thanks/i],
  time: [/–≤—Ä–µ–º—è|–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏/i],
  date: [/–¥–∞—Ç–∞|–∫–∞–∫–æ–µ —á–∏—Å–ª–æ|–∫–∞–∫–æ–π –¥–µ–Ω—å|—Å–µ–≥–æ–¥–Ω—è/i],
  weather: [/–ø–æ–≥–æ–¥–∞|–ø–æ–≥–æ–¥—É|—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/i],
  joke: [/—à—É—Ç–∫|–∞–Ω–µ–∫–¥–æ—Ç|—Ä–∞—Å—Å–º–µ—à–∏|joke/i],
  programming: [/–ø—Ä–æ–≥—Ä–∞–º–º|–∫–æ–¥|—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞|programming|code/i],
  ai: [/–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç|–Ω–µ–π—Ä–æ—Å–µ—Ç|–º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ|ai|ml/i],
  motivation: [/–º–æ—Ç–∏–≤–∞—Ü|–≤–¥–æ—Ö–Ω–æ–≤|–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è|—É—Å—Ç–∞–ª/i],
};

const contextualResponses = [
  {
    pattern: /–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã|–∫–∞–∫ –ø–æ–∂–∏–≤–∞–µ—à—å/i,
    response: '–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å –∏ –æ–±—â–∞—Ç—å—Å—è. –ê —É —Ç–µ–±—è –∫–∞–∫ –¥–µ–ª–∞?',
  },
  {
    pattern: /–∫—Ç–æ —Ç—ã|—á—Ç–æ —Ç—ã —Ç–∞–∫–æ–µ|—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ/i,
    response: '–Ø –Ø–ø–ø–µ—Ä ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ—Ç fantomInsight –∏ DeepSeek. –°–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–º–æ—â–∏, –æ–±—â–µ–Ω–∏—è –∏ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á. –†–∞–±–æ—Ç–∞—é –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏!',
  },
  {
    pattern: /deepseek|–¥–∏–ø—Å–∏–∫/i,
    response: 'DeepSeek ‚Äî —ç—Ç–æ –ø–µ—Ä–µ–¥–æ–≤–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ò–ò, –∫–æ—Ç–æ—Ä–∞—è –ª–µ–∂–∏—Ç –≤ –æ—Å–Ω–æ–≤–µ –º–æ–µ–π —Ä–∞–±–æ—Ç—ã. –ú–æ—â–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è!',
  },
  {
    pattern: /fantominsight|—Ñ–∞–Ω—Ç–æ–º –∏–Ω—Å–∞–π—Ç/i,
    response: 'fantomInsight ‚Äî –∫–æ–º–ø–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∞ –º–µ–Ω—è. –ú—ã —Å–æ–∑–¥–∞—ë–º —É–º–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –±—É–¥—É—â–µ–≥–æ!',
  },
];

function analyzeIntent(text: string): string | null {
  for (const [intent, patterns] of Object.entries(keywords)) {
    if (patterns.some(pattern => pattern.test(text))) {
      return intent;
    }
  }
  return null;
}

function getContextualResponse(text: string): string | null {
  for (const { pattern, response } of contextualResponses) {
    if (pattern.test(text)) {
      return response;
    }
  }
  return null;
}

function generateCreativeResponse(text: string): string {
  const hasQuestion = /\?/.test(text);
  const wordCount = text.split(' ').length;
  
  if (hasQuestion) {
    const templates = [
      `–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ü–æ –ø–æ–≤–æ–¥—É "${text.slice(0, 30)}..." –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ —ç—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?`,
      `–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –ß—Ç–æ–±—ã –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ "${text.slice(0, 30)}...", –º–Ω–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π. –£—Ç–æ—á–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞?`,
      `–î—É–º–∞—é –Ω–∞–¥ —Ç–≤–æ–∏–º –≤–æ–ø—Ä–æ—Å–æ–º! "${text.slice(0, 30)}..." ‚Äî —Ç–µ–º–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?`,
    ];
    return templates[Math.floor(Math.random() * templates.length)];
  }
  
  if (wordCount > 15) {
    return '–ü–æ–Ω–∏–º–∞—é —Ç–≤–æ–∏ –º—ã—Å–ª–∏! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–∞—è —Ç–µ–º–∞. –î–∞–≤–∞–π –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏ ‚Äî —á—Ç–æ —Ç–µ–±–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–∑–Ω–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?';
  }
  
  const genericResponses = [
    '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –º—ã—Å–ª—å! –†–∞—Å—Å–∫–∞–∂–∏ –±–æ–ª—å—à–µ –æ–± —ç—Ç–æ–º.',
    '–ü–æ–Ω—è–ª —Ç–µ–±—è. –ß—Ç–æ –¥—É–º–∞–µ—à—å –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?',
    '–õ—é–±–æ–ø—ã—Ç–Ω–æ! –ê –∫–∞–∫ —Ç—ã –∫ —ç—Ç–æ–º—É –ø—Ä–∏—à—ë–ª?',
    '–•–æ—Ä–æ—à–∞—è –∏–¥–µ—è! –î–∞–≤–∞–π —Ä–∞–∑–æ–≤—å—ë–º –µ—ë –≤–º–µ—Å—Ç–µ.',
    '–°–æ–≥–ª–∞—Å–µ–Ω, —ç—Ç–æ –≤–∞–∂–Ω–æ. –ö–∞–∫–∏–µ —É —Ç–µ–±—è –ø–ª–∞–Ω—ã?',
  ];
  
  return genericResponses[Math.floor(Math.random() * genericResponses.length)];
}

export function generateAIResponse(userMessage: string, history: Message[]): string {
  const text = userMessage.toLowerCase().trim();
  
  const contextual = getContextualResponse(text);
  if (contextual) return contextual;
  
  const intent = analyzeIntent(text);
  if (intent && responses[intent]) {
    const options = responses[intent];
    return options[Math.floor(Math.random() * options.length)];
  }
  
  if (history.length > 2) {
    const lastUserMessage = history.filter(m => m.role === 'user').slice(-1)[0];
    if (lastUserMessage && lastUserMessage.content.toLowerCase().includes(text.slice(0, 10))) {
      return '–ú—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —ç—Ç–æ –æ–±—Å—É–∂–¥–∞–ª–∏! –•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å —á—Ç–æ-—Ç–æ –µ—â—ë –∏–ª–∏ –ø–µ—Ä–µ–π–¥—ë–º –∫ –¥—Ä—É–≥–æ–π —Ç–µ–º–µ?';
    }
  }
  
  return generateCreativeResponse(userMessage);
}

export function generateConversationTitle(messages: Message[]): string {
  if (messages.length === 0) return '–ù–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä';
  
  const firstUserMessage = messages.find(m => m.role === 'user');
  if (!firstUserMessage) return '–ù–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä';
  
  const text = firstUserMessage.content;
  const words = text.split(' ').slice(0, 4).join(' ');
  return words.length > 30 ? words.slice(0, 30) + '...' : words;
}
